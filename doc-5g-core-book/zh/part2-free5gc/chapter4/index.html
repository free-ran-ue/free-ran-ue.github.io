<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="RAN/UE Simulation Tool"><meta name=author content=alonza0314><link href=https://free-ran-ue.github.io/doc-5g-core-book/zh/part2-free5gc/chapter4/ rel=canonical><link href=../chapter3/ rel=prev><link href=../chapter5/ rel=next><link rel=icon href=../../../../image/free-ran-ue-favicon.png><meta name=generator content="mkdocs-1.5.3, mkdocs-material-9.5.13"><title>第 4 章：AMF 詳解 - free-ran-ue</title><link rel=stylesheet href=../../../../assets/stylesheets/main.7e359304.min.css><link rel=stylesheet href=../../../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../../stylesheets/extra.css><script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=blue-grey data-md-color-accent=light-blue> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#4-amf class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../../.. title=free-ran-ue class="md-header__button md-logo" aria-label=free-ran-ue data-md-component=logo> <img src=../../../../image/free-ran-ue-logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> free-ran-ue </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> 第 4 章：AMF 詳解 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=blue-grey data-md-color-accent=light-blue aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=blue-grey data-md-color-accent=light-blue aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> </form> <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/free-ran-ue/free-ran-ue title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> alonza0314/free-ran-ue </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../../../doc-user-guide/ class=md-tabs__link> User Guide </a> </li> <li class=md-tabs__item> <a href=../../../../doc-design-document/ class=md-tabs__link> Design Document </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../../../en/ class=md-tabs__link> 5G Core Book </a> </li> <li class=md-tabs__item> <a href=../../../../doc-contributors/ class=md-tabs__link> Contributors </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../.. title=free-ran-ue class="md-nav__button md-logo" aria-label=free-ran-ue data-md-component=logo> <img src=../../../../image/free-ran-ue-logo.png alt=logo> </a> free-ran-ue </label> <div class=md-nav__source> <a href=https://github.com/free-ran-ue/free-ran-ue title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> alonza0314/free-ran-ue </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class=md-nav__item> <a href=../../../../doc-user-guide/ class=md-nav__link> <span class=md-ellipsis> User Guide </span> </a> </li> <li class=md-nav__item> <a href=../../../../doc-design-document/ class=md-nav__link> <span class=md-ellipsis> Design Document </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex> <span class=md-ellipsis> 5G Core Book </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=true> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> 5G Core Book </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_1> <label class=md-nav__link for=__nav_4_1 id=__nav_4_1_label tabindex> <span class=md-ellipsis> English </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_1_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1> <span class="md-nav__icon md-icon"></span> English </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../en/ class=md-nav__link> <span class=md-ellipsis> Home & Preface </span> </a> </li> <li class=md-nav__item> <a href=../../../en/author/ class=md-nav__link> <span class=md-ellipsis> About the Author </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_1_3> <label class=md-nav__link for=__nav_4_1_3 id=__nav_4_1_3_label tabindex=0> <span class=md-ellipsis> Part I - Foundation and Evolution of 5G Core Network </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_1_3_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1_3> <span class="md-nav__icon md-icon"></span> Part I - Foundation and Evolution of 5G Core Network </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../en/part1-history/chapter1/ class=md-nav__link> <span class=md-ellipsis> Chapter 1：From 4G to 5G — Evolution of Core Network Architecture </span> </a> </li> <li class=md-nav__item> <a href=../../../en/part1-history/chapter2/ class=md-nav__link> <span class=md-ellipsis> Chapter 2：5G Core Network Overview from 3GPP Perspective </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_1_4> <label class=md-nav__link for=__nav_4_1_4 id=__nav_4_1_4_label tabindex=0> <span class=md-ellipsis> Part II - In-Depth Analysis of free5GC Architecture </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_1_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1_4> <span class="md-nav__icon md-icon"></span> Part II - In-Depth Analysis of free5GC Architecture </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../en/part2-free5gc/chapter3/ class=md-nav__link> <span class=md-ellipsis> Chapter 3：free5GC Overall Architecture and Module Introduction </span> </a> </li> <li class=md-nav__item> <a href=../../../en/part2-free5gc/chapter4/ class=md-nav__link> <span class=md-ellipsis> Chapter 4：AMF Deep Dive </span> </a> </li> <li class=md-nav__item> <a href=../../../en/part2-free5gc/chapter5/ class=md-nav__link> <span class=md-ellipsis> Chapter 5：SMF, UPF and User Plane Procedures </span> </a> </li> <li class=md-nav__item> <a href=../../../en/part2-free5gc/chapter6/ class=md-nav__link> <span class=md-ellipsis> Chapter 6：Other Network Functions </span> </a> </li> <li class=md-nav__item> <a href=../../../en/part2-free5gc/chapter7/ class=md-nav__link> <span class=md-ellipsis> Chapter 7：Non-3GPP Access </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_1_5> <label class=md-nav__link for=__nav_4_1_5 id=__nav_4_1_5_label tabindex=0> <span class=md-ellipsis> Part III - free5GC Deployment and Common Issues </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_1_5_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1_5> <span class="md-nav__icon md-icon"></span> Part III - free5GC Deployment and Common Issues </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../en/part3-deploy/chapter8/ class=md-nav__link> <span class=md-ellipsis> Chapter 8：free5GC Deployment and Configuration </span> </a> </li> <li class=md-nav__item> <a href=../../../en/part3-deploy/chapter9/ class=md-nav__link> <span class=md-ellipsis> Chapter 9：Multi-Node / Multi-UPF Deployment </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_1_6> <label class=md-nav__link for=__nav_4_1_6 id=__nav_4_1_6_label tabindex=0> <span class=md-ellipsis> Part IV - free-ran-ue Simulator </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_1_6_label aria-expanded=false> <label class=md-nav__title for=__nav_4_1_6> <span class="md-nav__icon md-icon"></span> Part IV - free-ran-ue Simulator </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../en/part4-free-ran-ue/chapter10/ class=md-nav__link> <span class=md-ellipsis> Chapter 10：Why Do We Need a RAN/UE Simulator? </span> </a> </li> <li class=md-nav__item> <a href=../../../en/part4-free-ran-ue/chapter11/ class=md-nav__link> <span class=md-ellipsis> Chapter 11：Architecture Design of free-ran-ue </span> </a> </li> <li class=md-nav__item> <a href=../../../en/part4-free-ran-ue/chapter12/ class=md-nav__link> <span class=md-ellipsis> Chapter 12：How the Simulator Integrates with free5GC </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_2 checked> <label class=md-nav__link for=__nav_4_2 id=__nav_4_2_label tabindex> <span class=md-ellipsis> 中文 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_2_label aria-expanded=true> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> 中文 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../ class=md-nav__link> <span class=md-ellipsis> 首頁 & 前言 </span> </a> </li> <li class=md-nav__item> <a href=../../author/ class=md-nav__link> <span class=md-ellipsis> 作者介紹 </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_2_3> <label class=md-nav__link for=__nav_4_2_3 id=__nav_4_2_3_label tabindex=0> <span class=md-ellipsis> Part I - 5G 核心網路的基礎與演進背景 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_4_2_3> <span class="md-nav__icon md-icon"></span> Part I - 5G 核心網路的基礎與演進背景 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../part1-history/chapter1/ class=md-nav__link> <span class=md-ellipsis> 第 1 章：從 4G 到 5G — 核心網架構的演變 </span> </a> </li> <li class=md-nav__item> <a href=../../part1-history/chapter2/ class=md-nav__link> <span class=md-ellipsis> 第 2 章：5G 核心網 3GPP 角度總覽 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_2_4 checked> <label class=md-nav__link for=__nav_4_2_4 id=__nav_4_2_4_label tabindex=0> <span class=md-ellipsis> Part II - free5GC 全架構深度解析 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_2_4_label aria-expanded=true> <label class=md-nav__title for=__nav_4_2_4> <span class="md-nav__icon md-icon"></span> Part II - free5GC 全架構深度解析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../chapter3/ class=md-nav__link> <span class=md-ellipsis> 第 3 章：free5GC 整體架構與模組介紹 </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> 第 4 章：AMF 詳解 </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> 第 4 章：AMF 詳解 </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#41-amf class=md-nav__link> <span class=md-ellipsis> 4.1 AMF 在核心網路中的角色 </span> </a> </li> <li class=md-nav__item> <a href=#42-n2 class=md-nav__link> <span class=md-ellipsis> 4.2 N2 介面與相關協定 </span> </a> </li> <li class=md-nav__item> <a href=#421-n2 class=md-nav__link> <span class=md-ellipsis> 4.2.1 N2 </span> </a> <nav class=md-nav aria-label="4.2.1 N2"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#422-sctp class=md-nav__link> <span class=md-ellipsis> 4.2.2 SCTP </span> </a> </li> <li class=md-nav__item> <a href=#423-ngap class=md-nav__link> <span class=md-ellipsis> 4.2.3 NGAP </span> </a> </li> <li class=md-nav__item> <a href=#424-nas class=md-nav__link> <span class=md-ellipsis> 4.2.4 NAS </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#43-amf class=md-nav__link> <span class=md-ellipsis> 4.3 AMF 的啟動流程 </span> </a> </li> <li class=md-nav__item> <a href=#44-amf-fsm class=md-nav__link> <span class=md-ellipsis> 4.4 AMF 的 FSM 狀態機 </span> </a> </li> <li class=md-nav__item> <a href=#45-amf class=md-nav__link> <span class=md-ellipsis> 4.5 AMF 的實際業務內容 </span> </a> <nav class=md-nav aria-label="4.5 AMF 的實際業務內容"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#451-ue-registration class=md-nav__link> <span class=md-ellipsis> 4.5.1 UE 註冊（Registration） </span> </a> </li> <li class=md-nav__item> <a href=#452-ue-pdu-pdu-session-establishment class=md-nav__link> <span class=md-ellipsis> 4.5.2 UE PDU 會話建立（PDU Session Establishment） </span> </a> </li> <li class=md-nav__item> <a href=#453-ue-de-registration class=md-nav__link> <span class=md-ellipsis> 4.5.3 UE 註銷（De-registration） </span> </a> </li> <li class=md-nav__item> <a href=#454 class=md-nav__link> <span class=md-ellipsis> 4.5.4 其他業務 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#46 class=md-nav__link> <span class=md-ellipsis> 4.6 本章小節 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../chapter5/ class=md-nav__link> <span class=md-ellipsis> 第 5 章：SMF、UPF 與使用者面流程 </span> </a> </li> <li class=md-nav__item> <a href=../chapter6/ class=md-nav__link> <span class=md-ellipsis> 第 6 章：其他網路元件 </span> </a> </li> <li class=md-nav__item> <a href=../chapter7/ class=md-nav__link> <span class=md-ellipsis> 第 7 章：非 3GPP 接入 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_2_5> <label class=md-nav__link for=__nav_4_2_5 id=__nav_4_2_5_label tabindex=0> <span class=md-ellipsis> Part III - free5GC 實戰部署與常見問題 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_2_5_label aria-expanded=false> <label class=md-nav__title for=__nav_4_2_5> <span class="md-nav__icon md-icon"></span> Part III - free5GC 實戰部署與常見問題 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../part3-deploy/chapter8/ class=md-nav__link> <span class=md-ellipsis> 第 8 章：free5GC 部署實戰 </span> </a> </li> <li class=md-nav__item> <a href=../../part3-deploy/chapter9/ class=md-nav__link> <span class=md-ellipsis> 第 9 章：多節點 / 多 UPF 部署 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_2_6> <label class=md-nav__link for=__nav_4_2_6 id=__nav_4_2_6_label tabindex=0> <span class=md-ellipsis> Part IV - free-ran-ue 模擬器 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_4_2_6_label aria-expanded=false> <label class=md-nav__title for=__nav_4_2_6> <span class="md-nav__icon md-icon"></span> Part IV - free-ran-ue 模擬器 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../part4-free-ran-ue/chapter10/ class=md-nav__link> <span class=md-ellipsis> 第 10 章：為什麼需要 RAN/UE 模擬器？ </span> </a> </li> <li class=md-nav__item> <a href=../../part4-free-ran-ue/chapter11/ class=md-nav__link> <span class=md-ellipsis> 第 11 章：free-ran-ue 的架構設計 </span> </a> </li> <li class=md-nav__item> <a href=../../part4-free-ran-ue/chapter12/ class=md-nav__link> <span class=md-ellipsis> 第 12 章：模擬器如何與 free5GC 整合 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../../../doc-contributors/ class=md-nav__link> <span class=md-ellipsis> Contributors </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#41-amf class=md-nav__link> <span class=md-ellipsis> 4.1 AMF 在核心網路中的角色 </span> </a> </li> <li class=md-nav__item> <a href=#42-n2 class=md-nav__link> <span class=md-ellipsis> 4.2 N2 介面與相關協定 </span> </a> </li> <li class=md-nav__item> <a href=#421-n2 class=md-nav__link> <span class=md-ellipsis> 4.2.1 N2 </span> </a> <nav class=md-nav aria-label="4.2.1 N2"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#422-sctp class=md-nav__link> <span class=md-ellipsis> 4.2.2 SCTP </span> </a> </li> <li class=md-nav__item> <a href=#423-ngap class=md-nav__link> <span class=md-ellipsis> 4.2.3 NGAP </span> </a> </li> <li class=md-nav__item> <a href=#424-nas class=md-nav__link> <span class=md-ellipsis> 4.2.4 NAS </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#43-amf class=md-nav__link> <span class=md-ellipsis> 4.3 AMF 的啟動流程 </span> </a> </li> <li class=md-nav__item> <a href=#44-amf-fsm class=md-nav__link> <span class=md-ellipsis> 4.4 AMF 的 FSM 狀態機 </span> </a> </li> <li class=md-nav__item> <a href=#45-amf class=md-nav__link> <span class=md-ellipsis> 4.5 AMF 的實際業務內容 </span> </a> <nav class=md-nav aria-label="4.5 AMF 的實際業務內容"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#451-ue-registration class=md-nav__link> <span class=md-ellipsis> 4.5.1 UE 註冊（Registration） </span> </a> </li> <li class=md-nav__item> <a href=#452-ue-pdu-pdu-session-establishment class=md-nav__link> <span class=md-ellipsis> 4.5.2 UE PDU 會話建立（PDU Session Establishment） </span> </a> </li> <li class=md-nav__item> <a href=#453-ue-de-registration class=md-nav__link> <span class=md-ellipsis> 4.5.3 UE 註銷（De-registration） </span> </a> </li> <li class=md-nav__item> <a href=#454 class=md-nav__link> <span class=md-ellipsis> 4.5.4 其他業務 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#46 class=md-nav__link> <span class=md-ellipsis> 4.6 本章小節 </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=4-amf>第 4 章：AMF 詳解</h1> <h2 id=41-amf>4.1 AMF 在核心網路中的角色</h2> <p><img alt=sbi src=../../../image/part2/sbi.png></p> <p>在 5G 核心網路中，AMF（<strong>Access and Mobility Management Function，接入與行動性管理功能</strong>）是所有 UE 進入 5GC 的「第一站」。當一支手機開機、發起註冊、建立 PDU 會話或移動到新的區域時，相關的控制訊號幾乎都會先經過 AMF，再由 AMF 與其他 NF（例如 SMF、AUSF、UDM、PCF 等）協調後續處理。</p> <p>從功能角度來看，AMF 主要負責幾件事情：</p> <ul> <li><strong>接入控制與註冊管理</strong>：處理 UE 的註冊（Registration）、更新與註銷（De-registration），決定是否允許某個 UE 使用網路。</li> <li><strong>行動性與連線管理</strong>：追蹤 UE 所在的追蹤區（TA）、管理 RRC/NAS 連線狀態，協助完成切換（Handover）與重選（Reselection）相關流程。</li> <li><strong>安全與鑑權協調</strong>：與 AUSF、UDM 等 NF 協作，完成 UE 的鑑權與安全上下文建立，確保訊號與資料在無線與核心網段之間的保護。</li> <li><strong>會話建立協調者</strong>：在 UE 要建立 PDU 會話時，AMF 會根據策略與拓樸，選擇適當的 SMF，並協助建立 UE 與 SMF/UPF 之間的上下文。</li> </ul> <p>在介面上，AMF 一手連接 <strong>N1（UE ↔ AMF 的 NAS 訊息）</strong>，一手連接 <strong>N2（gNB ↔ AMF 的 NGAP 訊息）</strong>，同時也透過 SBA 上的各種 Nn 介面與核心網內其他 NF 溝通。因此，你可以把 AMF 想像成「<strong>5GC 控制平面入口的前台與交通指揮中心</strong>」，負責把來自無線側的需求轉換成核心網內部的服務呼叫。</p> <div class="admonition warning"> <p class=admonition-title>Caution</p> <p>NAS 雖然是 UE 與 AMF 之間的訊息，但依然是由 RAN 包裝在 NGAP 訊息裡面，透過 SCTP 連線來送入 AMF 的 N2 接口！並不是 UE 直接送到 AMF 上！</p> </div> <h2 id=42-n2>4.2 N2 介面與相關協定</h2> <p><img alt=protocol src=../../../image/part2/protocol.png></p> <h2 id=421-n2>4.2.1 N2</h2> <p>N2 介面是 5G RAN（gNB）與 5GC 控制面（AMF）之間的控制平面介面，主要承載：</p> <ul> <li>gNB 與 AMF 之間的訊號協調，例如 UE 附著、追蹤區更新、切換等程序</li> <li>承載 UE 的 NAS 訊息，將其包<strong>在 NGAP 訊息中轉送給 AMF 處理</strong></li> </ul> <p>在協定堆疊上，N2 介面通常使用 IP 之上的 <strong>SCTP</strong> 作為傳輸層協定，在其上運行 <strong>NGAP</strong> 應用層協定，而 UE 與核心網之間的 <strong>NAS</strong> 訊息則被封裝在 NGAP 訊息中，透過 N2 轉遞給 AMF，如上面的協定堆疊圖所示。</p> <h3 id=422-sctp>4.2.2 SCTP</h3> <p>SCTP（Stream Control Transmission Protocol）是一種訊息導向、支援多路徑與多串流的傳輸層協定，在 5G N2 介面中被用來承載 NGAP 訊息。與一般常見的 TCP 相比，SCTP 的幾個特點特別適合電信訊號：</p> <ul> <li><strong>多串流（Multi-streaming）</strong>：可以在一個連線中建立多個獨立的串流，減少 Head-of-Line Blocking 的影響，讓不同類型的訊號不會互相阻塞。</li> <li><strong>多歸屬（Multi-homing）</strong>：一個端點可以綁定多個 IP 位址，在其中一條路徑故障時，可以快速切換到備援路徑，提高可靠性。</li> <li><strong>訊息導向與明確的訊息邊界</strong>：比較符合「一則訊號一個 message」的使用模式，方便電信協定實作。</li> </ul> <p>在實作上，gNB 與 AMF 會各自在 N2 專用的 IP/Port 上建立 SCTP 連線，後續所有 NGAP 訊息都透過這條連線交換。</p> <h3 id=423-ngap>4.2.3 NGAP</h3> <p>NGAP（Next Generation Application Protocol）是運行在 N2 介面上的應用層訊號協定，負責定義 gNB 與 AMF 之間各種控制流程使用的訊息格式與程序。常見的 NGAP 程序包括：</p> <ul> <li>Initial UE Message / Initial Context Setup：用於 UE 初次註冊或建立 PDU 會話時的上下文建立</li> <li>UE Context Release：釋放 UE 在 gNB/AMF 之間的上下文</li> <li>Handover Preparation / Handover Resource Allocation：執行 UE 在不同 gNB 之間切換時的訊號協調</li> </ul> <p>在 free5GC 的 AMF 中，NGAP 模組會負責：</p> <ul> <li>解碼由 SCTP 收到的 NGAP PDU</li> <li>根據 PDU 類型分派到對應的處理程序（例如處理 Initial UE Message、UE Context Release 等）</li> <li>從 NGAP 中取出 NAS 負載（N1 message），交給 NAS 處理邏輯</li> </ul> <h3 id=424-nas>4.2.4 NAS</h3> <p>NAS（Non-Access Stratum）是 UE 與 5GC 之間的控制平面訊號層級，對 UE 來說，它是「直接跟核心網說話」的那一層。NAS 負責的內容包括：</p> <ul> <li>UE 註冊（Registration）、更新與註銷（De-registration）相關程序</li> <li>PDU 會話建立、修改與釋放的請求與回應</li> <li>安全模式（Security Mode）、身份識別（Identity）等控制程序</li> </ul> <p>在傳遞路徑上，NAS 訊息會：</p> <ol> <li>在 UE 與 gNB 之間，封裝在 RRC 訊息中傳輸；</li> <li>到達 gNB 後，由 gNB 透過 NGAP 將 NAS 負載包在適當的 NGAP 訊息內；</li> <li>經由 N2/SCTP 傳給 AMF，最後由 AMF 的 NAS 處理邏輯解碼與處理。</li> </ol> <div class="admonition note"> <p class=admonition-title>Note</p> <p>在上面的協定堆疊圖中可以看到 NAS 訊息又分為兩種：</p> <ul> <li>NAS-MM：UE 傳達資訊到 AMF 的訊息</li> <li>NAS-SM：UE 傳達資訊到 SMF 的訊息，但 NAS-SM 依舊是由 AMF 接收後經由 SBI 送到 SMF 上</li> </ul> </div> <h2 id=43-amf>4.3 AMF 的啟動流程</h2> <div class="admonition note"> <p class=admonition-title>Note</p> <p>這裡的啟動流程適用於其他 SBI 上除了 NRF 以外的 NF，後續介紹其他 NF 時便不會在多做說明！</p> </div> <p>在 free5GC 的實作中，AMF 的啟動流程大致可以分成幾個步驟，整體架構與本書第 3 章介紹的通用 NF 結構相呼應：</p> <ol> <li> <p><strong>讀取設定與初始化 Logger</strong></p> <p>啟動程式會先載入 AMF 的設定檔（例如本機 IP/Port、PLMN/TA 列表、NRF 位址、SCTP 參數等），並依據設定初始化日誌系統，確保後續每個模組都能寫出一致格式的 log。</p> </li> <li> <p><strong>建立 AMF 上下文（Context）</strong></p> <p>接著建立 AMF 的全域 context，內含：</p> <ul> <li>網路拓樸與 PLMN/TA 配置</li> <li>與其他 NF 溝通所需的 SBI client 設定</li> <li>內部使用的緩存、狀態表與計時器等</li> </ul> </li> <li> <p><strong>初始化 SBI Server 與 NRF 註冊</strong></p> <p>AMF 會啟動自己的 SBI HTTP server，對外提供服務，同時作為 client 主動向 NRF 註冊自己的服務能力與位址，讓其他 NF 可以透過 SBA 機制發現並呼叫 AMF。</p> </li> <li> <p><strong>啟動 N2（SCTP / NGAP）相關模組</strong></p> <p>啟動 N2 端口的 SCTP 監聽，初始化 NGAP 協定處理模組，準備接收來自 gNB 的 NGAP 訊息與其中所承載的 NAS 負載。</p> </li> <li> <p><strong>進入事件迴圈，處理訊號與錯誤</strong> </p> <p>最後，AMF 會進入主事件迴圈，持續處理：</p> <ul> <li>來自 N2 的 NGAP / NAS 訊息</li> <li>來自其他 NF 的 SBI 請求</li> <li>內部計時器觸發與狀態機更新</li> </ul> </li> </ol> <p>當你在閱讀 AMF 原始碼時，可以對照上述步驟，從啟動入口程式一路追到設定載入、context 建立、SBI 註冊與 N2 監聽等關鍵程式碼。</p> <h2 id=44-amf-fsm>4.4 AMF 的 FSM 狀態機</h2> <p>AMF 在實作上大量使用 <strong>FSM（Finite State Machine，有限狀態機）</strong> 來管理 UE 與訊號流程。原因很簡單：</p> <p>對每一支 UE 而言，從「還沒上線」到「成功註冊、建立 PDU 會話、最後註銷離線」，其實就是在不同的狀態之間移動，而每個狀態只允許發生特定的事件與轉移。如果不用狀態機清楚描述，程式碼很容易變成一堆 if-else，既難閱讀也難維護。</p> <p>目前 free5GC AMF 中的狀態機大致上可以用下面這張圖來看：</p> <p><img alt=fms src=../../../image/part2/fsm.png></p> <p>AMF 會從 UE 的起始非註冊狀態（Degistered）依照狀態機改變的邏輯來更新 AMF 中 UE context 的狀態。圖中三個顏色分別代表如下：</p> <ul> <li>橙色：事件觸發，轉移到下一個狀態</li> <li>綠色：事件成功，轉移到下一狀態</li> <li>紅色：事件失敗，回覆到前面的某一個狀態（通常會回復到其實狀態）</li> </ul> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>FSM 這個東西並不需要死背硬記，可以簡單這樣記：</p> <ol> <li>手機開機還沒註冊，準備開始註冊</li> <li>驗證雙方的基礎資料</li> <li>確認安全模式</li> <li>在 AMF 中建立 UE 的紀錄實例</li> <li>手機註冊成功！</li> </ol> </div> <h2 id=45-amf>4.5 AMF 的實際業務內容</h2> <div class="admonition note"> <p class=admonition-title>Note</p> <p>這邊會以 UE 的角度帶讀者了解 AMF 是如何處理 來自 UE 以及 RAN 的訊息，希望可以透過貼近日常生活的方式來新手也能很輕鬆的了解核網是如何處理這些資訊。</p> </div> <h3 id=451-ue-registration>4.5.1 UE 註冊（Registration）</h3> <p>先從最常見、也最關鍵的「UE 註冊」流程開始。你可以把註冊想像成「在機場櫃檯辦理報到」：UE 把自己的身分與需求告訴 AMF，AMF 檢查沒問題後，幫它建立一份「旅客檔案」，之後所有動作都會以這份檔案為基礎。</p> <p>從 UE 角度看，註冊大致會經歷這幾個步驟：</p> <ol> <li>UE 開機或進入需要服務的狀態時，透過 RRC（UE 與 gNB 之間使用的協定） 與 gNB 建立連線，然後把 <strong>Registration Request（NAS 訊息）</strong> 交給 gNB。 </li> <li>gNB 將這個 NAS 負載包在 Initial UE Message（NGAP）裡面，透過 N2/SCTP 傳給 AMF。 </li> <li>AMF 收到後，根據註冊原因、PLMN/TA 資訊與 UE 能力，決定要不要接受這支 UE，並觸發與 AUSF/UDM 的鑑權、取得訂閱資料。 </li> <li>當安全與訂閱都 OK 後，AMF 回傳 Registration Accept 給 UE，同時在內部建立與這支 UE 對應的上下文（包含識別資訊、TA 列表、安全參數等）。</li> </ol> <p>之後，只要 UE 還在「已註冊」狀態中，AMF 就會依照 FSM 設計處理各種更新與移動相關的事件。</p> <h3 id=452-ue-pdu-pdu-session-establishment>4.5.2 UE PDU 會話建立（PDU Session Establishment）</h3> <p>完成註冊之後，UE 還需要建立至少一個 <strong>PDU Session</strong> 才能真正「上網」。可以把這看成是「在機場辦完報到後，還要領登機證並分配座位」：<br> UE 告訴網路自己想要什麼樣的連線（例如用哪個 DNN/切片、走哪種 QoS），AMF 則負責幫它找到合適的 SMF/UPF，並完成整套路徑的建立。</p> <p>從 UE 角度來看，PDU 會話建立的運作大致如下：</p> <ol> <li>UE 發送 PDU Session Establishment Request（NAS-SM 訊息），內容包含 DNN、S-NSSAI、請求的 SSC mode 等資訊，透過 N2 傳到 AMF。 </li> <li>AMF 檢查 UE 當前註冊與安全狀態，並依據策略與拓樸選擇一個合適的 SMF（可能會向 NRF 查詢可用的 SMF 實例）。 </li> <li>AMF 透過 SBI 向選定的 SMF 發出建立 PDU Session 的請求（例如 Nsmf_PDUSession_Create），並等待 SMF 回覆分配的 IP 位址、UPF 資訊與 QoS 相關設定。 </li> <li>最後，AMF 透過 NAS 回覆 UE（PDU Session Establishment Accept），同時協調 gNB 完成對應的 N3/N9 路徑與 QoS 設定。</li> </ol> <p>在這個流程中，AMF 比較像是「<strong>代辦與協調者</strong>」：並不直接處理使用者平面的封包，但負責把 UE 的服務需求轉成 SMF/UPF 端實際的路由與資源分配。</p> <h3 id=453-ue-de-registration>4.5.3 UE 註銷（De-registration）</h3> <p>每一段旅程終究會結束：當 UE 關機、主動切斷連線，或因為長時間未活動被網路主動釋放時，就會進入 <strong>註銷（De-registration）</strong> 流程。這一步的目的，是幫 UE 與網路雙方把還在使用的資源好好收尾。</p> <p>從 UE 角度來看，註銷流程大致包含：</p> <ol> <li>UE 主動送出 Deregistration Request（NAS-MM 訊息），或在某些情況下由網路側觸發註銷程序。 </li> <li> <p>AMF 收到後，會：</p> <ul> <li>通知相關的 SMF/UPF 釋放對應的 PDU 會話與資源 </li> <li>更新自身的 UE 上下文狀態（從「已註冊」切回「未註冊」） </li> <li>在必要時向其他 NF（例如 PCF、UDM）清除暫存狀態</li> </ul> </li> <li> <p>最後，AMF 回覆 De-registration Accept 給 UE，表示這次「旅程」正式結束。</p> </li> </ol> <p>透過完整的註銷程序，網路才能確保資源被正確回收，不會因為異常離線或逾時而留下無用的上下文與 QoS 配置。</p> <h3 id=454>4.5.4 其他業務</h3> <p>除了上述幾個最常見、最核心的流程之外，AMF 還會處理許多與行動性與接入相關的業務，例如：</p> <ul> <li>追蹤區更新（Tracking Area Update, TAU）與相關計時器管理</li> <li>Paging（呼叫閒置狀態 UE）與服務請求流程</li> <li>換手（Handover）</li> </ul> <p>這些業務在日常網路運作中扮演重要角色，但在本書中，我們會先聚焦在「<strong>註冊、PDU 會話、註銷</strong>」這三條主幹流程，讓讀者先把 AMF 與 UE 之間的核心互動搞清楚，後續想要再更深入的研究其他功能時也能更容易的入手。</p> <h2 id=46>4.6 本章小節</h2> <p>本章說明了 AMF 作為 UE 進入 5GC 的「第一站」，如何一手連接 N1/N2 訊號，一手透過 SBA 與 SMF、AUSF、UDM、PCF 等 NF 協作，完成接入控制、行動性管理、安全協調與 PDU 會話建立等工作。</p> <p>接著，我們透過 N2 協定堆疊（SCTP/NGAP/NAS）、啟動流程與 FSM 狀態機，從實作角度拆解 AMF 處理訊息與管理 UE 生命週期的方式。</p> <p>最後，本章以 UE 視角走過註冊、PDU 會話與註銷三條主幹流程，並點出 TAU、Paging、Handover 等其他業務，為後續深入 SMF、UPF 等 NF 的章節建立必要的背景。</p> <div class=chapter-nav> <a href=../chapter5/ class="nav-btn nav-next" title="下一章：SMF、UPF 與使用者面流程"> <span class=arrow></span> </a> </div> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2025 Alonza0314. All rights reserved. </div> </div> <div class=md-social> <a href=https://github.com/alonza0314 target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.top", "search.highlight", "search.share", "header.autohide", "content.code.copy", "content.code.select", "content.tabs.link"], "search": "../../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../../../assets/javascripts/bundle.c8d2eff1.min.js></script> <script src=../../../../javascripts/extra.js></script> </body> </html>